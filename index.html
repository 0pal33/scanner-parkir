<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wayahe Parkir</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body { text-align:center; font-family:Arial; background:#f5f5f5; margin:0; padding:20px; }
#reader { width:260px; margin:auto; border-radius:20px; overflow:hidden; }

button {
 width:90%;
 padding:16px;
 margin:10px;
 border:none;
 border-radius:14px;
 font-size:18px;
}

.start{background:black;color:white;}
.stop{background:red;color:white;}
.checkin{background:green;color:white;}
.checkout{background:red;color:white;}
.cancel{background:orange;color:white;}
.manual{background:#2d77c7;color:white;}
.admin{background:#555;color:white;}
</style>
</head>

<body>

<div id="reader"></div>

<button id="startBtn" class="start" onclick="startScan()">START SCANNING</button>
<button id="stopBtn" class="stop" onclick="stopScan()" style="display:none;">STOP SCANNING</button>

<div id="info"></div>

<button id="checkinBtn" class="checkin" style="display:none;" onclick="checkin()">CHECK-IN</button>
<button id="checkoutBtn" class="checkout" style="display:none;" onclick="checkout()">CHECKOUT SEKARANG</button>
<button id="cancelBtn" class="cancel" style="display:none;" onclick="cancel()">BATALKAN PARKIR</button>

<button class="manual" onclick="manualInput()">Ketik Manual</button>
<button class="admin" onclick="location.href='admin.html'">Login Admin</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let html5QrCode;
let lastQR = null;

// WIB
function nowWIB(){
 let d = new Date();
 return new Date(d.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
}

// parse masuk (timestamp atau string)
function parseMasuk(val){

 if(!val) return null;

 if(typeof val === "string"){
   return new Date(val);
 }

 if(val.toDate){
   return val.toDate();
 }

 return new Date(val);
}

// hitung hari
function hitungHari(masukVal){

 let masuk = parseMasuk(masukVal);
 if(!masuk) return 0;

 let now = nowWIB();

 let diff = Math.ceil((now - masuk)/(1000*60*60*24));
 if(diff<1) diff=1;

 let jamMasuk = masuk.getHours();
 let jamNow = now.getHours();

 if(jamMasuk>=21 && jamMasuk<=23){
   let bedaHari = now.getDate() - masuk.getDate();
   if(bedaHari==1 && jamNow<=6) diff=1;
 }

 return diff;
}

// scan
async function startScan(){
 html5QrCode = new Html5Qrcode("reader");
 const devices = await Html5Qrcode.getCameras();
 const back = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

 html5QrCode.start(back.id,{fps:10,qrbox:200},handleQR);

 startBtn.style.display="none";
 stopBtn.style.display="block";
}

function stopScan(){
 html5QrCode.stop();
 startBtn.style.display="block";
 stopBtn.style.display="none";
}

// handle QR
async function handleQR(qr){
 if(!qr.startsWith("Parkir-")) return;
 lastQR=qr;

 let doc = await db.collection("parkir").doc(qr).get();

 if(!doc.exists){
   info.innerHTML="Belum aktif";
   checkinBtn.style.display="block";
   checkoutBtn.style.display="none";
   cancelBtn.style.display="none";
 }
 else{
   let masukVal = doc.data().masuk;
   let hari = hitungHari(masukVal);
   let tarif = hari * 3000;

   let masuk = parseMasuk(masukVal);

   info.innerHTML=
   "Masuk: "+ masuk.toLocaleString("id-ID")+
   "<br>Lama: "+hari+" hari"+
   "<br>Tagihan: Rp "+tarif;

   checkinBtn.style.display="none";
   checkoutBtn.style.display="block";
   cancelBtn.style.display="block";
 }
}

// manual
function manualInput(){
 let num=prompt("Masukkan nomor:");
 if(!num) return;
 handleQR("Parkir-"+num);
}

// checkin
async function checkin(){
 await db.collection("parkir").doc(lastQR).set({
   masuk: nowWIB()
 });
 alert("Checkin sukses");
}

// checkout
async function checkout(){
 let doc = await db.collection("parkir").doc(lastQR).get();
 let hari = hitungHari(doc.data().masuk);

 await db.collection("checkout").add({
   qr:lastQR,
   hari:hari,
   bayar:hari*3000,
   tanggal: nowWIB().toLocaleDateString("id-ID"),
   waktu: nowWIB().toISOString()
 });

 await db.collection("parkir").doc(lastQR).delete();
 alert("Checkout sukses");
}

// batal
async function cancel(){
 await db.collection("parkir").doc(lastQR).delete();
 alert("Parkir dibatalkan");
}

</script>
</body>
</html>
