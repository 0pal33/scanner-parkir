<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/html5-qrcode"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{
font-family:Arial;
background:#eee;
text-align:center;
margin:0;
padding:15px;
}

button{
width:90%;
padding:18px;
margin:10px auto;
border:none;
border-radius:12px;
font-size:18px;
color:white;
display:block;
}

#startBtn{background:black;}
#stopBtn{background:red;display:none;}
#checkinBtn{background:green;display:none;}
#checkoutBtn{background:red;display:none;}
#cancelBtn{background:orange;display:none;}
#manualBtn{background:#2c74b3;}
#loginBtn{background:#666;}

#reader{
width:300px;
margin:auto;
border-radius:20px;
overflow:hidden;
display:none;
}

#result{margin-top:10px;font-size:18px;}
</style>

</head>
<body>

<div id="reader"></div>

<button id="startBtn" onclick="startScan()">START SCANNING</button>
<button id="stopBtn" onclick="stopScan()">STOP SCANNING</button>

<div id="result"></div>

<button id="checkinBtn" onclick="checkin()">CHECK-IN</button>
<button id="checkoutBtn" onclick="checkout()">CHECKOUT SEKARANG</button>
<button id="cancelBtn" onclick="cancelParkir()">BATALKAN PARKIR</button>

<button id="manualBtn" onclick="manualInput()">Ketik Manual</button>
<button id="loginBtn" onclick="location.href='admin.html'">Login Admin</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let qrCode="";
let html5QrCode;
let camId;

async function startScan(){
html5QrCode = new Html5Qrcode("reader");
let devices = await Html5Qrcode.getCameras();
camId = devices.find(d=>d.label.toLowerCase().includes("back"))?.id || devices[0].id;

document.getElementById("reader").style.display="block";
document.getElementById("startBtn").style.display="none";
document.getElementById("stopBtn").style.display="block";

html5QrCode.start(
camId,
{fps:10,qrbox:250},
msg=>{
qrCode=msg;
loadData();
}
);
}

function stopScan(){
html5QrCode.stop();
document.getElementById("reader").style.display="none";
document.getElementById("startBtn").style.display="block";
document.getElementById("stopBtn").style.display="none";
}

async function loadData(){
let ref = db.collection("parkir").doc(qrCode);
let snap = await ref.get();

if(!snap.exists){
showCheckin();
return;
}

let data=snap.data();

if(data.status==="on"){
let now=new Date();
let masuk=data.checkinAt.toDate();

let diff=Math.floor((now-masuk)/(1000*60*60*24))+1;
let tarif=diff*3000;

document.getElementById("result").innerHTML=
`
<b>${qrCode}</b><br>
Masuk: ${masuk.toLocaleString('id-ID')}<br>
Lama: ${diff} hari<br>
Tagihan: Rp ${tarif}
`;

document.getElementById("checkoutBtn").style.display="block";
document.getElementById("cancelBtn").style.display="block";
}else{
showCheckin();
}
}

function showCheckin(){
document.getElementById("result").innerHTML="QR siap digunakan";
document.getElementById("checkinBtn").style.display="block";
}

async function checkin(){
await db.collection("parkir").doc(qrCode).set({
status:"on",
checkinAt: new Date()
});
loadData();
}

async function checkout(){
let ref=db.collection("parkir").doc(qrCode);
let snap=await ref.get();
let data=snap.data();

let masuk=data.checkinAt.toDate();
let now=new Date();

let diff=Math.floor((now-masuk)/(1000*60*60*24))+1;
let total=diff*3000;

await db.collection("checkout").add({
qr:qrCode,
checkin:masuk,
checkout:now,
total:total
});

await ref.update({status:"off"});
alert("Checkout berhasil");
location.reload();
}

async function cancelParkir(){
await db.collection("parkir").doc(qrCode).update({
status:"off"
});
alert("Parkir dibatalkan");
location.reload();
}

function manualInput(){
let num=prompt("Masukkan 3 digit:");
if(num){
qrCode="Parkir-"+num.padStart(3,"0");
loadData();
}
}

</script>
</body>
</html>
