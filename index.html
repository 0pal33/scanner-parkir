<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wayahe Parkir</title>

<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/html5-qrcode"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {margin:0;background:#f5f5f5;text-align:center;font-family:sans-serif;}
#reader {width:85%;margin:20px auto;border-radius:16px;overflow:hidden;}
button {width:90%;padding:18px;font-size:20px;margin:10px;border:none;border-radius:12px;}
.start {background:black;color:white;}
.stop {background:red;color:white;}
.green {background:green;color:white;}
.red {background:red;color:white;}
.blue {background:#007bff;color:white;}
</style>
</head>

<body>

<div id="reader"></div>
<div id="result"></div>

<button class="start" onclick="startScan()">START SCANNING</button>
<button class="stop" onclick="stopScan()">STOP SCANNING</button>
<button class="blue" onclick="manualInput()">Ketik Manual</button>
<button class="blue" onclick="adminLogin()">Login Admin</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let html5QrCode;
let currentCamera = "environment";

// WIB
function getWIB(){
let now = new Date();
let wib = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
return {
date: `${wib.getFullYear()}-${wib.getMonth()+1}-${wib.getDate()}`,
hour: wib.getHours(),
time: wib.toLocaleString("id-ID")
};
}

// VALID QR
function validQR(qr){
return /^Parkir-\d{3}$/.test(qr);
}

// HITUNG HARI
function hitungHari(data){
let now = getWIB();
let t1 = new Date(data.tanggal);
let t2 = new Date(now.date);
let beda = Math.round((t2-t1)/(1000*60*60*24));
if(beda==0) return 1;
if(beda==1){
if(data.jam>=21 && now.hour<=6) return 1;
return 2;
}
return beda+1;
}

// SCAN
function onScanSuccess(qr){

if(!validQR(qr)){
document.getElementById("result").innerHTML = "<p>QR tidak valid</p>";
return;
}

let ref = db.collection("parkir").doc(qr);

ref.get().then(doc=>{
if(!doc.exists){
document.getElementById("result").innerHTML =
`<h3>${qr}</h3>
<button class="green" onclick="checkIn('${qr}')">CHECK-IN</button>`;
}else{
let data = doc.data();
let hari = hitungHari(data);
let total = hari*3000;
document.getElementById("result").innerHTML =
`<h3>${qr}</h3>
<p>Masuk: ${data.waktu}</p>
<p>Lama: ${hari} hari</p>
<p>Tagihan: Rp ${total.toLocaleString("id-ID")}</p>
<button class="red" onclick="checkOut('${qr}')">CHECKOUT SEKARANG</button>`;
}
});
}

// CHECKIN
function checkIn(qr){
let now=getWIB();
db.collection("parkir").doc(qr).set({
tanggal: now.date,
jam: now.hour,
waktu: now.time
});
}

// CHECKOUT
function checkOut(qr){
if(!confirm("Motor keluar?")) return;
db.collection("parkir").doc(qr).delete();
document.getElementById("result").innerHTML="";
}

// MANUAL
function manualInput(){
let angka=prompt("Masukkan angka parkir");
if(!/^\d{3}$/.test(angka)) return alert("Harus 3 digit");
onScanSuccess("Parkir-"+angka);
}

// START
function startScan(){
html5QrCode=new Html5Qrcode("reader");
html5QrCode.start(
{ facingMode: currentCamera },
{ fps:10, qrbox:250 },
onScanSuccess
);
}

// STOP
function stopScan(){
if(html5QrCode){
html5QrCode.stop();
}
}

// LOGIN ADMIN
function adminLogin(){

let email = prompt("Email admin:");
let password = prompt("Password:");

firebase.auth().signInWithEmailAndPassword(email,password)
.then(()=>{
window.location.href="admin.html";
})
.catch(()=>{
alert("Login gagal");
});
}

</script>

</body>
</html>
