<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wayahe Parkir</title>

<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/html5-qrcode"></script>

<!-- FIREBASE COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {
 text-align:center;
 font-family: Arial;
 background:#f5f5f5;
 margin:0;
 padding:20px;
}

#reader {
 width:260px;
 margin:auto;
 border-radius:20px;
 overflow:hidden;
}

button {
 width:90%;
 padding:16px;
 margin:10px;
 border:none;
 border-radius:14px;
 font-size:18px;
}

.start { background:black; color:white; }
.stop { background:red; color:white; }
.checkin { background:green; color:white; }
.checkout { background:red; color:white; }
.manual { background:#2d77c7; color:white; }
.admin { background:#555; color:white; }
</style>
</head>

<body>

<div id="reader"></div>

<button id="startBtn" class="start" onclick="startScan()">START SCANNING</button>
<button id="stopBtn" class="stop" onclick="stopScan()" style="display:none;">STOP SCANNING</button>

<div id="result"></div>

<button id="checkinBtn" class="checkin" style="display:none;" onclick="checkin()">CHECK-IN</button>
<button id="checkoutBtn" class="checkout" style="display:none;" onclick="checkout()">CHECKOUT SEKARANG</button>

<button class="manual" onclick="manualInput()">Ketik Manual</button>
<button class="admin" onclick="location.href='admin.html'">Login Admin</button>

<script>

// ==== FIREBASE CONFIG ====
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ==== SCANNER ====
let html5QrCode;
let lastQR = null;

async function startScan(){
 html5QrCode = new Html5Qrcode("reader");

 const devices = await Html5Qrcode.getCameras();
 const back = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

 html5QrCode.start(
   back.id,
   { fps:10, qrbox:200 },
   qr => {
     if(!qr.startsWith("Parkir-")) return;

     lastQR = qr;
     document.getElementById("result").innerHTML = qr;

     document.getElementById("checkinBtn").style.display="block";
     document.getElementById("checkoutBtn").style.display="block";
   }
 );

 document.getElementById("startBtn").style.display="none";
 document.getElementById("stopBtn").style.display="block";
}

function stopScan(){
 if(html5QrCode) html5QrCode.stop();

 document.getElementById("startBtn").style.display="block";
 document.getElementById("stopBtn").style.display="none";
}

// ==== MANUAL ====
function manualInput(){
 let num = prompt("Masukkan angka parkir:");
 if(!num) return;

 lastQR = "Parkir-"+num;
 document.getElementById("result").innerHTML = lastQR;

 document.getElementById("checkinBtn").style.display="block";
 document.getElementById("checkoutBtn").style.display="block";
}

// ==== CHECKIN ====
async function checkin(){
 if(!lastQR) return;

 await db.collection("parkir").doc(lastQR).set({
   masuk: new Date().toISOString(),
   status:"aktif"
 });

 alert("Check-in sukses");
}

// ==== CHECKOUT ====
async function checkout(){
 if(!lastQR) return;

 const ref = db.collection("parkir").doc(lastQR);
 const snap = await ref.get();

 if(!snap.exists) return alert("Belum checkin");

 await db.collection("checkout").add({
   qr:lastQR,
   waktu:new Date().toLocaleString()
 });

 await ref.delete();

 alert("Checkout sukses");
}

// ==== PWA ====
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js');
}

</script>

</body>
</html>
