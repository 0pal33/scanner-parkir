<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">

<title>Scanner Parkir</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{
font-family:Arial;
background:#eee;
text-align:center;
margin:0;
padding:15px;
}

button{
width:90%;
padding:18px;
margin:10px auto;
border:none;
border-radius:12px;
font-size:18px;
color:white;
display:block;
}

#startBtn{background:black;}
#stopBtn{background:red; display:none;}
#checkinBtn{background:green; display:none;}
#checkoutBtn{background:red; display:none;}
#cancelBtn{background:orange; display:none;}
#manualBtn{background:#2d73b9;}
#adminBtn{background:gray;}

#reader{
width:85%;
margin:auto;
display:none;
}

#manualBox{
display:none;
margin:10px;
}

input{
padding:15px;
font-size:18px;
width:150px;
text-align:center;
}

</style>
</head>

<body>

<button id="startBtn">START SCANNING</button>
<div id="reader"></div>
<button id="stopBtn">STOP SCANNING</button>

<div id="info"></div>

<button id="checkinBtn">CHECK-IN</button>
<button id="checkoutBtn">CHECKOUT SEKARANG</button>
<button id="cancelBtn">BATALKAN PARKIR</button>

<button id="manualBtn">Ketik Manual</button>

<div id="manualBox">
Parkir- <input id="manualInput" maxlength="3">
<button onclick="manualOk()">✓</button>
<button onclick="manualCancel()">✕</button>
</div>

<button id="adminBtn" onclick="location.href='admin.html'">Login Admin</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let html5QrCode;
let activeQR = "";

document.getElementById("startBtn").onclick = async ()=>{
html5QrCode = new Html5Qrcode("reader");
document.getElementById("reader").style.display="block";
document.getElementById("startBtn").style.display="none";
document.getElementById("stopBtn").style.display="block";

await html5QrCode.start(
{ facingMode: "environment" },
{ fps: 10, qrbox: 250 },
qr=>{
if(!qr.startsWith("Parkir-")) return;
activeQR = qr;
loadData(qr);
}
);
};

document.getElementById("stopBtn").onclick = async ()=>{
await html5QrCode.stop();
document.getElementById("reader").style.display="none";
document.getElementById("startBtn").style.display="block";
document.getElementById("stopBtn").style.display="none";
};

function loadData(qr){
db.collection("parkir").doc(qr).get().then(doc=>{
if(!doc.exists){
document.getElementById("checkinBtn").style.display="block";
return;
}
let data = doc.data();
if(data.status=="on"){
document.getElementById("checkoutBtn").style.display="block";
document.getElementById("cancelBtn").style.display="block";
}
});
}

document.getElementById("checkinBtn").onclick = ()=>{
db.collection("parkir").doc(activeQR).set({
status:"on",
checkinAt: firebase.firestore.Timestamp.now()
});
};

document.getElementById("checkoutBtn").onclick = ()=>{
db.collection("checkout").add({
qr: activeQR,
bayar:3000,
checkoutAt: firebase.firestore.Timestamp.now()
});
db.collection("parkir").doc(activeQR).delete();
};

document.getElementById("cancelBtn").onclick = ()=>{
db.collection("parkir").doc(activeQR).delete();
};

document.getElementById("manualBtn").onclick = ()=>{
document.getElementById("manualBox").style.display="block";
};

function manualOk(){
let val=document.getElementById("manualInput").value;
activeQR="Parkir-"+val;
loadData(activeQR);
document.getElementById("manualBox").style.display="none";
}

function manualCancel(){
document.getElementById("manualBox").style.display="none";
}
</script>
</body>
</html>
