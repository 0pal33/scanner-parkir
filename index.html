<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner Parkir</title>

<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/html5-qrcode"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{font-family:Arial;background:#eee;text-align:center;margin:0;padding:15px}
button{width:90%;padding:16px;margin:10px auto;border:none;border-radius:12px;font-size:18px;color:white;display:block}
#startBtn{background:black}
#stopBtn{background:red;display:none}
#checkinBtn{background:green}
#checkoutBtn{background:red}
#cancelBtn{background:orange}
#manualBtn{background:#2b6cb0}
#adminBtn{background:gray}
#reader{width:80%;margin:auto;display:none}
#manualBox{display:none}
input{padding:10px;font-size:16px;width:150px}
.iconBtn{padding:10px;width:auto;margin-left:5px}
</style>
</head>

<body>

<div id="reader"></div>

<button id="startBtn">START SCANNING</button>
<button id="stopBtn">STOP SCANNING</button>

<div id="info"></div>

<button id="checkinBtn" style="display:none">CHECK-IN</button>
<button id="checkoutBtn" style="display:none">CHECKOUT SEKARANG</button>
<button id="cancelBtn" style="display:none">BATALKAN PARKIR</button>

<button id="manualBtn">Ketik Manual</button>

<div id="manualBox">
Parkir-
<input id="manualInput" maxlength="3" type="number">
<button class="iconBtn" onclick="submitManual()">✓</button>
<button class="iconBtn" onclick="cancelManual()">✕</button>
</div>

<button id="adminBtn" onclick="location.href='admin.html'">Login Admin</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let scanner;
let currentQR = null;

document.getElementById("startBtn").onclick = startScan;
document.getElementById("stopBtn").onclick = stopScan;

function startScan(){
document.getElementById("reader").style.display="block";
document.getElementById("startBtn").style.display="none";
document.getElementById("stopBtn").style.display="block";

scanner = new Html5Qrcode("reader");
scanner.start({ facingMode:"environment" }, { fps:10, qrbox:250 },
qr=>{
handleQR(qr);
});
}

function stopScan(){
scanner.stop();
document.getElementById("reader").style.display="none";
document.getElementById("startBtn").style.display="block";
document.getElementById("stopBtn").style.display="none";
}

function handleQR(qr){
if(!qr.startsWith("Parkir-")) return;
currentQR = qr;

db.collection("parkir").doc(qr).get().then(doc=>{
if(!doc.exists || doc.data().status!="on"){
showCheckin();
}else{
showActive(doc.data().checkinAt.toDate());
}
});
}

function showCheckin(){
document.getElementById("info").innerHTML="Belum aktif";
document.getElementById("checkinBtn").style.display="block";
document.getElementById("checkoutBtn").style.display="none";
document.getElementById("cancelBtn").style.display="none";
}

function showActive(date){
let now = new Date();
let durasi = Math.ceil((now-date)/(1000*60*60*24));
let tarif = durasi*3000;

document.getElementById("info").innerHTML=
"Masuk: "+date.toLocaleString('id-ID')+
"<br>Lama: "+durasi+" hari"+
"<br>Tagihan: Rp "+tarif;

document.getElementById("checkinBtn").style.display="none";
document.getElementById("checkoutBtn").style.display="block";
document.getElementById("cancelBtn").style.display="block";
}

document.getElementById("checkinBtn").onclick = ()=>{
db.collection("parkir").doc(currentQR).set({
status:"on",
checkinAt: firebase.firestore.Timestamp.now()
});
alert("Check-in sukses");
};

document.getElementById("checkoutBtn").onclick = ()=>{
db.collection("checkout").add({
qr:currentQR,
bayar:3000,
checkoutAt: firebase.firestore.Timestamp.now()
});
db.collection("parkir").doc(currentQR).delete();
alert("Checkout sukses");
};

document.getElementById("cancelBtn").onclick = ()=>{
db.collection("parkir").doc(currentQR).delete();
alert("Dibatalkan");
};

document.getElementById("manualBtn").onclick = ()=>{
document.getElementById("manualBox").style.display="block";
document.getElementById("manualBtn").style.display="none";
};

function submitManual(){
handleQR("Parkir-"+document.getElementById("manualInput").value);
cancelManual();
}

function cancelManual(){
document.getElementById("manualBox").style.display="none";
document.getElementById("manualBtn").style.display="block";
}
</script>
</body>
</html>
