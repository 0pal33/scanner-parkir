<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner Parkir</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {margin:0;font-family:sans-serif;text-align:center;background:#f5f5f5;}
#reader {width:100%;}
button {width:90%;padding:20px;font-size:22px;margin:10px;border:none;border-radius:12px;}
.green {background:green;color:white;}
.red {background:red;color:white;}
.blue {background:#007bff;color:white;}
</style>
</head>

<body>

<h2>Scan QR Parkir</h2>

<div id="reader"></div>
<div id="result"></div>

<button class="blue" onclick="manualInput()">Ketik QR Manual</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== LOGIKA FINAL WIB =====
function hitungHari(masuk){

  let now = new Date();

  let masukW = new Date(masuk.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
  let nowW   = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));

  let tMasuk = new Date(masukW.getFullYear(), masukW.getMonth(), masukW.getDate());
  let tNow   = new Date(nowW.getFullYear(), nowW.getMonth(), nowW.getDate());

  let bedaTanggal = Math.round((tNow - tMasuk)/(1000*60*60*24));

  let jamMasuk = masukW.getHours();
  let jamNow   = nowW.getHours();

  // Hari yang sama
  if(bedaTanggal == 0){
    return 1;
  }

  // Beda 1 hari
  if(bedaTanggal == 1){

    // aturan malam
    if(jamMasuk >= 21 && jamNow <= 6){
      return 1;
    }

    return 2;
  }

  // Lebih dari 1 hari
  return bedaTanggal + 1;
}
// ===========================

function tampilKosong(qr){
  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: KOSONG</p>
   <button class="green" onclick="checkIn('${qr}')">CHECK-IN</button>`;
}

function tampilAktif(qr, masuk){

  let hari = hitungHari(masuk);
  let total = hari * 3000;
  let rupiah = total.toLocaleString("id-ID");

  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: AKTIF</p>
   <p>Lama: ${hari} hari</p>
   <p>Tagihan: Rp ${rupiah}</p>
   <button class="red" onclick="checkOut('${qr}')">CHECK-OUT</button>`;
}

function onScanSuccess(qr){

  let docRef = db.collection("parkir").doc(qr);

  docRef.get().then((doc)=>{
    if(!doc.exists){
      tampilKosong(qr);
    }else{
      tampilAktif(qr, doc.data().checkin.toDate());
    }
  });
}

function checkIn(qr){
  db.collection("parkir").doc(qr).set({checkin:new Date()});
  tampilAktif(qr,new Date());
}

function checkOut(qr){
  let konfirmasi = confirm("Motor keluar?");
  if(!konfirmasi) return;
  db.collection("parkir").doc(qr).delete();
  tampilKosong(qr);
}

function manualInput(){
  let manual = prompt("Masukkan kode QR:");
  if(manual){ onScanSuccess(manual); }
}

let scanner = new Html5QrcodeScanner("reader",{fps:10,qrbox:300});
scanner.render(onScanSuccess);

</script>

</body>
</html>
