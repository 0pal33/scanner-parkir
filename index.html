<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">

<title>Scanner Parkir</title>

<!-- FIREBASE SDK (WAJIB DI SINI) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>

<style>

body{
font-family:Arial;
background:#eee;
text-align:center;
margin:0;
padding:15px;
}

button{
width:90%;
padding:18px;
margin:10px auto;
border:none;
border-radius:12px;
font-size:18px;
color:white;
display:block;
}

.start{background:black;}
.stop{background:red;}
.checkin{background:green;}
.checkout{background:red;}
.batal{background:orange;}
.manual{background:#3b82f6;}
.login{background:#666;}

#video{
width:90%;
max-width:400px;
border-radius:15px;
margin:15px auto;
display:block;
}

.info{
margin-top:10px;
font-size:18px;
}

</style>

</head>

<body>

<video id="video" autoplay></video>

<button id="startBtn" class="start">START SCANNING</button>
<button id="stopBtn" class="stop" style="display:none;">STOP SCANNING</button>

<div id="info" class="info"></div>

<button id="checkinBtn" class="checkin" style="display:none;">CHECK-IN</button>
<button id="checkoutBtn" class="checkout" style="display:none;">CHECKOUT SEKARANG</button>
<button id="batalBtn" class="batal" style="display:none;">BATALKAN PARKIR</button>

<button id="manualBtn" class="manual">Ketik Manual</button>
<button id="loginBtn" class="login">Login Admin</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentQR = null;
let stream = null;


// ====== PARSER DATA LAMA & BARU ======
function parseMasukWIB(masuk){

 if(!masuk) return null;

 if(masuk.includes("T")){
   return new Date(masuk);
 }

 try{
   let [tgl,jam] = masuk.split(", ");
   let [d,m,y] = tgl.split("/");
   let [h,i,s] = jam.split(".");

   return new Date(y, m-1, d, h, i, s);

 }catch{
   return null;
 }
}



// ===== WIB NOW =====
function nowWIB(){
 let now = new Date();
 return new Date(now.getTime() + (7*60*60*1000));
}



// ===== DURASI LOGIC =====
function hitungDurasi(masuk){

 let now = nowWIB();

 let jamMasuk = masuk.getHours();

 if(jamMasuk >= 21){
   let besok = new Date(masuk);
   besok.setDate(besok.getDate()+1);
   besok.setHours(6,0,0,0);

   if(now < besok) return 1;
 }

 let diff = now - masuk;
 let hari = Math.ceil(diff / (1000*60*60*24));

 return hari < 1 ? 1 : hari;
}



// ===== TAMPIL DATA =====
function tampilkanData(masuk){

 if(!masuk || isNaN(masuk)){
   document.getElementById("info").innerHTML="Data lama / rusak<br>Silakan checkout / batalkan";
   showAction();
   return;
 }

 let durasi = hitungDurasi(masuk);
 let tarif = durasi * 3000;

 document.getElementById("info").innerHTML=
 "Masuk: "+masuk.toLocaleString('id-ID')+
 "<br>Lama: "+durasi+" hari"+
 "<br>Tagihan: Rp "+tarif;

 showAction();
}



// ===== BUTTON STATE =====
function showAction(){
 document.getElementById("checkinBtn").style.display="none";
 document.getElementById("checkoutBtn").style.display="block";
 document.getElementById("batalBtn").style.display="block";
}



// ===== SCAN SIMULASI =====
async function prosesQR(qr){

 currentQR = qr;

 let doc = await db.collection("parkir").doc(qr).get();

 if(!doc.exists){
   document.getElementById("checkinBtn").style.display="block";
   document.getElementById("checkoutBtn").style.display="none";
   document.getElementById("batalBtn").style.display="none";
   return;
 }

 let data = doc.data();
 let masuk = parseMasukWIB(data.masuk);

 tampilkanData(masuk);

 // AUTO MIGRASI FORMAT LAMA
 if(data.masuk && !data.masuk.includes("T")){
   await db.collection("parkir").doc(qr).update({
     masuk: masuk.toISOString()
   });
 }

}



// ===== CHECKIN =====
document.getElementById("checkinBtn").onclick = async ()=>{
 let now = new Date().toISOString();

 await db.collection("parkir").doc(currentQR).set({
   masuk: now
 });

 alert("Check-in berhasil");
};



// ===== CHECKOUT =====
document.getElementById("checkoutBtn").onclick = async ()=>{

 let doc = await db.collection("parkir").doc(currentQR).get();

 if(!doc.exists) return;

 let masuk = parseMasukWIB(doc.data().masuk);
 let durasi = hitungDurasi(masuk);
 let bayar = durasi * 3000;

 let now = nowWIB();

 await db.collection("checkout").add({
   qr: currentQR,
   bayar: bayar,
   tanggal: now.toISOString().split("T")[0],
   waktu: now.toLocaleString('id-ID')
 });

 await db.collection("parkir").doc(currentQR).delete();

 alert("Checkout sukses");
};



// ===== BATAL =====
document.getElementById("batalBtn").onclick = async ()=>{
 await db.collection("parkir").doc(currentQR).delete();
 alert("Parkir dibatalkan");
};



// ===== START CAMERA =====
document.getElementById("startBtn").onclick = async ()=>{
 stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 document.getElementById("video").srcObject = stream;

 document.getElementById("startBtn").style.display="none";
 document.getElementById("stopBtn").style.display="block";
};



// ===== STOP CAMERA =====
document.getElementById("stopBtn").onclick = ()=>{
 stream.getTracks().forEach(track=>track.stop());
 document.getElementById("startBtn").style.display="block";
 document.getElementById("stopBtn").style.display="none";
};



// ===== LOGIN ADMIN =====
document.getElementById("loginBtn").onclick = async ()=>{
 let email = prompt("Email");
 let pass = prompt("Password");

 await auth.signInWithEmailAndPassword(email,pass);
 window.location="admin.html";
};

</script>

</body>
</html>
