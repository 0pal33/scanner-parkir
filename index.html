<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner Parkir</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {
  margin:0;
  font-family:sans-serif;
  text-align:center;
  background:#f5f5f5;
}

#reader {
  width:100%;
}

button {
  width:90%;
  padding:20px;
  font-size:22px;
  margin:10px;
  border:none;
  border-radius:12px;
}

.green { background:green; color:white; }
.red { background:red; color:white; }
.blue { background:#007bff; color:white; }

#result {
  margin-top:15px;
  font-size:18px;
}
</style>

</head>
<body>

<h2>Scan QR Parkir</h2>

<div id="reader"></div>
<div id="result"></div>

<button class="blue" onclick="manualInput()">Ketik QR Manual</button>

<script>

// ðŸ”¹ Firebase config (pakai yang sama)
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function waktuWIB(date){
  return new Date(date.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
}



function tampilKosong(qr){
  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: KOSONG</p>
   <button class="green" onclick="checkIn('${qr}')">CHECK-IN</button>`;
}

function tampilAktif(qr, masuk){

  let hari = hitungHari(masuk);
  let total = hari function hitungHari(masuk){

  let now = waktuWIB(new Date());
  let masukW = waktuWIB(masuk);

  // ambil tanggal saja (tanpa jam)
  let tMasuk = new Date(masukW.getFullYear(), masukW.getMonth(), masukW.getDate());
  let tKeluar = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let selisihHari = Math.floor((tKeluar - tMasuk) / (1000*60*60*24));

  let masukJam = masukW.getHours();
  let keluarJam = now.getHours();

  // aturan malam
  if (masukJam >= 21 && selisihHari == 1 && keluarJam <= 6){
    return 1;
  }

  return selisihHari + 1;
  }* 3000;
  let rupiah = total.toLocaleString("id-ID");
  let jamMasuk = waktuWIB(masuk).toLocaleString();

  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: AKTIF</p>
   <p>Masuk: ${jamMasuk}</p>
   <p>Lama: ${hari} hari</p>
   <p>Tagihan: Rp ${rupiah}</p>
   <button class="red" onclick="checkOut('${qr}')">CHECK-OUT</button>`;
}

function onScanSuccess(qr){

  let docRef = db.collection("parkir").doc(qr);

  docRef.get().then((doc)=>{

    if(!doc.exists){
      tampilKosong(qr);
    }else{
      tampilAktif(qr, doc.data().checkin.toDate());
    }

  });
}

function checkIn(qr){

  db.collection("parkir").doc(qr).set({
    checkin: new Date()
  });

  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: AKTIF</p>
   <p>Motor berhasil masuk</p>`;
}

function checkOut(qr){

  let konfirmasi = confirm("Motor keluar?");
  if(!konfirmasi) return;

  db.collection("parkir").doc(qr).delete();

  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: KOSONG</p>
   <p>Slot siap dipakai</p>`;
}

function manualInput(){
  let manual = prompt("Masukkan kode QR:");
  if(manual){
    onScanSuccess(manual);
  }
}

let scanner = new Html5QrcodeScanner(
  "reader",
  { fps: 10, qrbox: 300 }
);

scanner.render(onScanSuccess);

</script>

</body>
</html>
