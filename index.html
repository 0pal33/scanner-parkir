<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner Parkir</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {margin:0;font-family:sans-serif;text-align:center;background:#f5f5f5;}
#reader {width:100%;margin-bottom:20px;}
button {width:90%;padding:20px;font-size:22px;margin:15px;border:none;border-radius:12px;}
.green {background:green;color:white;}
.red {background:red;color:white;}
.blue {background:#007bff;color:white;}
.black {background:black;color:white;}
</style>
</head>

<body>

<h2>Scan QR Parkir</h2>

<div id="reader"></div>
<div id="result"></div>

<button class="blue" onclick="manualInput()">Ketik Manual</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== VALIDASI FORMAT QR =====
function validQR(qr){
  return /^Parkir-\d{3}$/.test(qr);
}

// ===== WIB =====
function getWIB(){

  let now = new Date();
  let wib = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));

  return {
    date: `${wib.getFullYear()}-${wib.getMonth()+1}-${wib.getDate()}`,
    hour: wib.getHours(),
    time: wib.toLocaleString("id-ID")
  };
}

// ===== HITUNG HARI =====
function hitungHari(data){

  let now = getWIB();

  let t1 = new Date(data.tanggal);
  let t2 = new Date(now.date);

  let bedaTanggal = Math.round((t2-t1)/(1000*60*60*24));

  if(bedaTanggal == 0) return 1;

  if(bedaTanggal == 1){
    if(data.jam >= 21 && now.hour <= 6) return 1;
    return 2;
  }

  return bedaTanggal + 1;
}

// ===== UI =====
function tampilKosong(qr){
  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: KOSONG</p>
   <button class="green" onclick="checkIn('${qr}')">CHECK-IN</button>`;
}

function tampilAktif(qr,data){

  let hari = hitungHari(data);
  let total = hari * 3000;
  let rupiah = total.toLocaleString("id-ID");

  document.getElementById("result").innerHTML =
  `<h3>${qr}</h3>
   <p>Status: AKTIF</p>
   <p>Masuk: ${data.waktu}</p>
   <p>Lama: ${hari} hari</p>
   <p>Tagihan: Rp ${rupiah}</p>
   <button class="red" onclick="checkOut('${qr}')">CHECK-OUT</button>`;
}

function tampilInvalid(){
  document.getElementById("result").innerHTML =
  `<p>QR tidak valid</p>`;
}

// ===== SCAN =====
function onScanSuccess(qr){

  if(!validQR(qr)){
    tampilInvalid();
    return;
  }

  let docRef = db.collection("parkir").doc(qr);

  docRef.get().then((doc)=>{
    if(!doc.exists){
      tampilKosong(qr);
    }else{
      tampilAktif(qr, doc.data());
    }
  });
}

// ===== CHECK-IN =====
function checkIn(qr){

  let now = getWIB();

  db.collection("parkir").doc(qr).set({
    tanggal: now.date,
    jam: now.hour,
    waktu: now.time
  });

  tampilAktif(qr,{
    tanggal: now.date,
    jam: now.hour,
    waktu: now.time
  });
}

// ===== CHECK-OUT =====
function checkOut(qr){
  let konfirmasi = confirm("Motor keluar?");
  if(!konfirmasi) return;
  db.collection("parkir").doc(qr).delete();
  tampilKosong(qr);
}

// ===== MANUAL =====
function manualInput(){

  let angka = prompt("Masukkan angka parkir (contoh: 123)");

  if(!angka) return;

  if(!/^\d{3}$/.test(angka)){
    alert("Harus 3 digit");
    return;
  }

  let qr = "Parkir-" + angka;

  onScanSuccess(qr);
}

// ===== SCANNER =====
let scanner = new Html5QrcodeScanner(
  "reader",
  { fps: 10, qrbox: 300 }
);

scanner.render(onScanSuccess);

</script>

</body>
</html>
