<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Wayahe Parkir</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body {
  margin:0;
  font-family:sans-serif;
  background:#f5f5f5;
  text-align:center;
}

#reader {
  width:90%;
  margin:auto;
  margin-top:10px;
  border-radius:20px;
  overflow:hidden;
}

button {
  width:90%;
  padding:18px;
  margin:8px;
  border:none;
  border-radius:12px;
  font-size:18px;
}

.startBtn { background:black; color:white; }
.stopBtn { background:red; color:white; }
.checkinBtn { background:green; color:white; }
.checkoutBtn { background:red; color:white; }
.manualBtn { background:#1976d2; color:white; }
.flipBtn {
  position:absolute;
  bottom:15px;
  right:15px;
  background:white;
  color:black;
  padding:12px;
  border-radius:50%;
}

.resultBox {
  background:white;
  margin:10px;
  padding:15px;
  border-radius:15px;
}
</style>

</head>

<body>

<div id="reader"></div>

<button class="startBtn" onclick="startScan()">START SCANNING</button>
<button class="stopBtn" onclick="stopScan()">STOP SCANNING</button>

<div id="result" class="resultBox"></div>

<button class="manualBtn" onclick="manualInput()">Ketik Manual</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let html5QrCode = new Html5Qrcode("reader");
let currentCamera = { facingMode: "environment" };

function startScan(){
  html5QrCode.start(
    currentCamera,
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      handleQR(qrCodeMessage);
    }
  );
}

function stopScan(){
  html5QrCode.stop();
}

function handleQR(qr){

  if(!qr.startsWith("Parkir-")){
    document.getElementById("result").innerHTML = "<b>QR tidak valid</b>";
    return;
  }

  let ref = db.collection("parkir").doc(qr);
  let now = new Date();

  ref.get().then(doc => {

    if(!doc.exists){

      ref.set({
        checkin: now
      });

      document.getElementById("result").innerHTML =
      "<h3>"+qr+"</h3><p>Status: AKTIF</p>";

    } else {

      let masuk = doc.data().checkin.toDate();
      let durasi = hitungDurasi(masuk, now);
      let total = durasi * 3000;

      document.getElementById("result").innerHTML =
      "<h3>"+qr+"</h3>"+
      "<p>Status: AKTIF</p>"+
      "<p>Lama: "+durasi+" hari</p>"+
      "<p>Tagihan: Rp "+total+"</p>"+
      "<button class='checkoutBtn' onclick='checkout(\""+qr+"\","+total+")'>CHECKOUT SEKARANG</button>";

    }

  });
}

function hitungDurasi(masuk, sekarang){

  let hari = Math.ceil((sekarang - masuk) / (1000*60*60*24));

  let jamMasuk = masuk.getHours();
  let jamDari = sekarang.getHours();

  if(jamMasuk >=21 && jamDari <=6){
    hari = 1;
  }

  return hari < 1 ? 1 : hari;
}

function checkout(qr,total){

  db.collection("checkout").add({
    qr: qr,
    bayar: total,
    waktu: new Date().toLocaleString()
  });

  db.collection("parkir").doc(qr).delete();

  document.getElementById("result").innerHTML =
  "<h3>"+qr+"</h3><p>Selesai</p>";
}

function manualInput(){
  let nomor = prompt("Masukkan nomor (contoh: 206)");
  if(nomor){
    handleQR("Parkir-"+nomor);
  }
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>

</body>
</html>
