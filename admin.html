<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{
font-family:Arial;
background:#eee;
text-align:center;
margin:0;
padding:15px;
}

input{
padding:12px;
margin:10px;
width:80%;
font-size:16px;
}

button{
padding:15px;
border:none;
border-radius:10px;
margin:10px;
width:90%;
font-size:16px;
color:white;
}

.login{background:black;}
.cancel{background:grey;}
.logout{
position:fixed;
top:10px;
right:10px;
background:red;
}
.active{background:orange;}
.back{background:black;}

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
background:white;
}

td,th{
border:1px solid #ccc;
padding:12px;
}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
<h2>Login Admin</h2>
<input type="email" id="email" placeholder="Email"><br>
<input type="password" id="password" placeholder="Password"><br>

<button class="login" onclick="login()">Login</button>
<button class="cancel" onclick="location.href='index.html'">Batal</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none">

<button class="logout" onclick="logout()">Logout</button>

<h2>Dashboard</h2>

<table>
<tr>
<th></th>
<th>Checkout</th>
<th>Total</th>
</tr>

<tr>
<td>Hari Ini</td>
<td id="d_checkout">0</td>
<td id="d_total">0</td>
</tr>

<tr>
<td>Minggu Ini</td>
<td id="w_checkout">0</td>
<td id="w_total">0</td>
</tr>

<tr>
<td>Bulan Ini</td>
<td id="m_checkout">0</td>
<td id="m_total">0</td>
</tr>
</table>

<button class="active" onclick="showActive()">Parkir Aktif</button>

<div id="activeList"></div>

</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
</script>

<script>

// AUTH CHECK
auth.onAuthStateChanged(user=>{
if(user){
document.getElementById("loginPage").style.display="none";
document.getElementById("dashboard").style.display="block";
}else{
document.getElementById("loginPage").style.display="block";
document.getElementById("dashboard").style.display="none";
}
});

// LOGIN
function login(){
let email = document.getElementById("email").value;
let pass = document.getElementById("password").value;

auth.signInWithEmailAndPassword(email,pass)
.catch(err=>alert("Login gagal"));
}

// LOGOUT
function logout(){
auth.signOut();
}

// PARKIR AKTIF
function showActive(){

document.getElementById("activeList").innerHTML="Loading...";

db.collection("parkir")
.where("status","==","on")
.get()
.then(snapshot=>{

if(snapshot.empty){
document.getElementById("activeList").innerHTML="Tidak ada parkir aktif";
return;
}

let html="<table><tr><th>QR</th><th>Check-in</th><th>Durasi</th></tr>";

snapshot.forEach(doc=>{

let d = doc.data();
let checkin = d.checkinAt?.toDate?.() || new Date();
let now = new Date();

let durasi = Math.floor((now - checkin)/(1000*60*60*24))+1;

html += `<tr>
<td>${doc.id}</td>
<td>${checkin.toLocaleString("id-ID",{timeZone:"Asia/Jakarta"})}</td>
<td>${durasi} hari</td>
</tr>`;
});

html+="</table><br><button class='back' onclick='location.reload()'>Kembali</button>";

document.getElementById("activeList").innerHTML=html;

});
}

</script>

</body>
</html>
