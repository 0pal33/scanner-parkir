<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{
font-family:Arial;
background:#eee;
text-align:center;
margin:0;
padding:15px;
}

input{
padding:12px;
margin:10px;
width:80%;
font-size:16px;
}

button{
padding:15px;
border:none;
border-radius:10px;
margin:10px;
width:90%;
font-size:16px;
color:white;
}

.login{background:black;}
.cancel{background:grey;}
.logout{
position:fixed;
top:10px;
right:10px;
background:red;
width:45px;
height:45px;
border-radius:10px;
font-size:20px;
padding:0;
display:flex;
align-items:center;
justify-content:center;
}
.back{background:black;}

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
background:white;
}

td,th{
border:1px solid #ccc;
padding:12px;
}
.active{
background:orange;
color:white;
font-weight:bold;
}
.monthBtn{
background:#ff9800;
font-weight:bold;
width:90%;
margin:10px auto;
display:block;
}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
<h2>Login Admin</h2>
<input type="email" id="email" placeholder="Email"><br>
<input type="password" id="password" placeholder="Password"><br>

<button class="login" onclick="login()">Login</button>
<button class="cancel" onclick="location.href='index.html'">Batal</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none">

<button class="logout" onclick="logout()">⏻</button>

<h2>Dashboard</h2>

<table>
<tr>
<th></th>
<th>Checkout</th>
<th>Total</th>
</tr>

<tr>
<td>Hari Ini</td>
<td id="d_checkout">0</td>
<td id="d_total">0</td>
</tr>

<tr>
<td>Minggu Ini</td>
<td id="w_checkout">0</td>
<td id="w_total">0</td>
</tr>

<tr>
<td>Bulan Ini</td>
<td id="m_checkout">0</td>
<td id="m_total">0</td>
</tr>
</table>

<button class="active" onclick="openActive()">Parkir Aktif</button>
<button class="active" onclick="openHistory()">Laporan Sebelumnya</button>
<script>



</script>
<div id="tarifBox" style="margin-top:20px;background:white;padding:15px;border-radius:10px">
<h3>Edit Tarif</h3>
<input type="number" id="tarifInput" placeholder="Tarif per hari">
<button class="active" onclick="saveTarif()">Simpan Tarif</button>
</div>
<!-- PARKIR AKTIF PAGE -->
<div id="activePage" style="display:none">

<h2>Parkir Aktif</h2>

<div id="activeTable"></div>

<button class="back" onclick="backToDashboard()">Kembali</button>

</div>
<!-- HISTORY PAGE -->
<div id="historyPage" style="display:none">

<h2>Laporan Sebelumnya</h2>

<div id="historyButtons"></div>

<button class="back" onclick="backToDashboard()">Kembali</button>

</div>
<!-- MONTH PAGE -->
<div id="monthPage" style="display:none">

<h2 id="monthTitle"></h2>

<div id="monthTable"></div>

<button class="back" onclick="backToHistory()">Kembali</button>

</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCbB2eqYAxCM1DvkSyCyoqKwq39mvCBwCQ",
  authDomain: "parkir-demo.firebaseapp.com",
  projectId: "parkir-demo",
  storageBucket: "parkir-demo.firebasestorage.app",
  messagingSenderId: "962001897575",
  appId: "1:962001897575:web:811c1902e3a274f7bb6cc2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
</script>

<script>

// AUTH CHECK
auth.onAuthStateChanged(user=>{
if(user){
document.getElementById("loginPage").style.display="none";
document.getElementById("dashboard").style.display="block";
loadDashboard();   // ⬅ TAMBAHKAN INI
}else{
document.getElementById("loginPage").style.display="block";
document.getElementById("dashboard").style.display="none";
}
});

// LOGIN
function login(){
let email = document.getElementById("email").value;
let pass = document.getElementById("password").value;

auth.signInWithEmailAndPassword(email,pass)
.catch(err=>alert("Login gagal"));
}

// LOGOUT
function logout(){
auth.signOut();
}

</script>
<script>

// ================= WIB TIME HELPER =================
function getWIBDate(){
return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Jakarta"}));
}

function getDayKey(date){
return date.toISOString().slice(0,10);
}

function getWeekKey(date){
let d = new Date(date);
let day = d.getDay() || 7;
d.setDate(d.getDate() - day + 1);
return d.toISOString().slice(0,10);
}

function getMonthKey(date){
return date.getFullYear()+"-"+(date.getMonth()+1);
}

// ================= LOAD DASHBOARD =================
function loadDashboard(){

let now = getWIBDate();
let dayStart = startOfDayWIB();
let weekStart = startOfWeekWIB();
let monthStart = startOfMonthWIB();
let dayKey = getDayKey(now);
let weekKey = getWeekKey(now);
let monthKey = getMonthKey(now);

db.collection("checkout")
.where("checkoutAt",">=", dayStart)
.get()
.then(snap=>{
document.getElementById("d_checkout").innerText = snap.size;

let total = 0;
snap.forEach(doc=> total += doc.data().bayar || 0);
document.getElementById("d_total").innerText = total;
});

// MINGGU
let monday = new Date(now);
let day = monday.getDay() || 7;
monday.setDate(monday.getDate() - day + 1);

db.collection("checkout")
.where("checkoutAt",">=", weekStart)
.get()
.then(snap=>{
document.getElementById("w_checkout").innerText = snap.size;

let total = 0;
snap.forEach(doc=> total += doc.data().bayar || 0);
document.getElementById("w_total").innerText = total;
});

// BULAN
let first = new Date(now.getFullYear(), now.getMonth(), 1);

db.collection("checkout")
.where("checkoutAt",">=", monthStart)
.get()
.then(snap=>{
document.getElementById("m_checkout").innerText = snap.size;

let total = 0;
snap.forEach(doc=> total += doc.data().bayar || 0);
document.getElementById("m_total").innerText = total;
});

}

// AUTO LOAD
auth.onAuthStateChanged(user=>{
if(user){
loadDashboard();
}
});

// ================= AUTO CLEAN 3 BULAN =================
function cleanOldData(){

let now = getWIBDate();
let threeMonthsAgo = new Date(now);
threeMonthsAgo.setMonth(now.getMonth()-3);

db.collection("checkout")
.where("checkoutAt","<",threeMonthsAgo)
.get()
.then(snap=>{
snap.forEach(doc=>{
db.collection("checkout").doc(doc.id).delete();
});
});

}

// ================= TARIF DINAMIS =================
function loadTarif(){

db.collection("config").doc("tarif").get()
.then(doc=>{
if(!doc.exists){
db.collection("config").doc("tarif").set({
perHari:3000
});
}
});

}

// INIT
loadTarif();
cleanOldData();
// ================= WIB START TIME =================
function startOfDayWIB(){
let d = getWIBDate();
d.setHours(0,0,0,0);
return d;
}

function startOfWeekWIB(){
let d = getWIBDate();
let day = d.getDay() || 7;
if(day !== 1){
d.setDate(d.getDate() - day + 1);
}
d.setHours(0,0,0,0);
return d;
}

function startOfMonthWIB(){
let d = getWIBDate();
d.setDate(1);
d.setHours(0,0,0,0);
return d;
}
</script>

<script>

// LOAD TARIF KE INPUT
function loadTarifToInput(){
db.collection("config").doc("tarif").get()
.then(doc=>{
if(doc.exists){
document.getElementById("tarifInput").value = doc.data().perHari;
}
});
}

// SIMPAN TARIF
function saveTarif(){

let val = Number(document.getElementById("tarifInput").value);

if(!val || val < 0){
alert("Tarif tidak valid");
return;
}

db.collection("config").doc("tarif").set({
perHari: val
})
.then(()=>{
alert("Tarif berhasil diupdate");
});

}

// AUTO LOAD SAAT LOGIN
auth.onAuthStateChanged(user=>{
if(user){
loadTarifToInput();
}
});

</script>
<script>

function openActive(){

document.getElementById("dashboard").style.display="none";
document.getElementById("activePage").style.display="block";

loadActivePage();

}

function openHistory(){

document.getElementById("dashboard").style.display="none";
document.getElementById("historyPage").style.display="block";

loadHistoryButtons();

}

function backToDashboard(){

document.getElementById("dashboard").style.display="block";
document.getElementById("activePage").style.display="none";
document.getElementById("historyPage").style.display="none";
document.getElementById("monthPage").style.display="none";

}

function backToHistory(){

document.getElementById("historyPage").style.display="block";
document.getElementById("monthPage").style.display="none";

}
</script>

<script>
function loadActivePage(){

document.getElementById("activeTable").innerHTML="Loading...";

db.collection("parkir")
.where("status","==","on")
.get()
.then(snapshot=>{

if(snapshot.empty){
document.getElementById("activeTable").innerHTML="Tidak ada parkir aktif";
return;
}

let html="<table><tr><th>QR</th><th>Check-in</th><th>Durasi</th></tr>";

snapshot.forEach(doc=>{

let d = doc.data();
let checkin = d.checkinAt?.toDate?.() || new Date();
let now = getWIBDate();

let durasi = Math.floor((now - checkin)/(1000*60*60*24))+1;

html += `<tr>
<td>${doc.id}</td>
<td>${checkin.toLocaleString("id-ID",{timeZone:"Asia/Jakarta"})}</td>
<td>${durasi} hari</td>
</tr>`;
});

html+="</table>";

document.getElementById("activeTable").innerHTML=html;

});

}

</script>
<script>

function loadHistoryButtons(){

let now = getWIBDate();
let html="";

for(let i=1;i<=2;i++){

let d = new Date(now);
d.setMonth(now.getMonth()-i);

let label = d.toLocaleString("id-ID",{month:"long",year:"numeric"});

html += `<button class="monthBtn" onclick="openMonth(${d.getFullYear()},${d.getMonth()})">${label}</button>`;

}

document.getElementById("historyButtons").innerHTML=html;

}

function openMonth(year,month){

document.getElementById("historyPage").style.display="none";
document.getElementById("monthPage").style.display="block";

let start = new Date(year,month,1);
let end = new Date(year,month+1,1);

document.getElementById("monthTitle").innerText =
start.toLocaleString("id-ID",{month:"long",year:"numeric"});

db.collection("checkout")
.where("checkoutAt",">=",start)
.where("checkoutAt","<",end)
.get()
.then(snap=>{

let count = snap.size;
let total = 0;

snap.forEach(doc=>{
total += doc.data().bayar || 0;
});

document.getElementById("monthTable").innerHTML = `
<table>
<tr><th>Checkout</th><th>Total</th></tr>
<tr><td>${count}</td><td>${total}</td></tr>
</table>
`;

});

}
</script>
</body>
</html>
